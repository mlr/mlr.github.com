
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta http-equiv="content-language" content="en-us" />
  <meta name="robots" content="index, follow" />
  <meta name="description" content="Ronnie Miller is a software developer living in Portland, Oregon. He utilizes Ruby, Rails and a variety of frontend tools to build workflow tools, web applications and whatever else happens to catch his interest." />
  <meta name="keywords" content="Ronnie Miller, software developer, web developer, software engineer, consultant, ruby, ruby on rails, jquery, emberjs, postgresql" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Image uploads with Google Apps Script - Ronnie Miller - Software Developer</title>
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />

</head>

<body>
<div id="wrapper">
  <header>
    <div id="name"><a href="/">Ronnie Miller</a></div>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/work">Work</a></li>
      </ul>
    </nav>
  </header>

  <div id="container">

    <div id="content" class="blog-post image-uploads-google-apps-script">
      <h1><a href="/2017/02/02/image-uploads-google-apps-script/">Image uploads with Google Apps Script</a></h1>
      

      <div class="post-meta">
        <div class="post-date">
          February
          
          2nd,
          2017
        </div>
      </div>

      <div class="post-content">
        <ul id="markdown-toc">
  <li><a href="#google-apps-script" id="markdown-toc-google-apps-script">Google Apps Script</a>    <ul>
      <li><a href="#what-is-it" id="markdown-toc-what-is-it">What is it?</a>        <ul>
          <li><a href="#elements-of-a-document" id="markdown-toc-elements-of-a-document">Elements of a Document</a></li>
        </ul>
      </li>
      <li><a href="#how-to-run-apps-script" id="markdown-toc-how-to-run-apps-script">How to Run Apps Script</a>        <ul>
          <li><a href="#adding-text-to-the-page" id="markdown-toc-adding-text-to-the-page">Adding Text to the Page</a></li>
          <li><a href="#using-the-logger" id="markdown-toc-using-the-logger">Using the Logger</a></li>
        </ul>
      </li>
      <li><a href="#events-and-triggers" id="markdown-toc-events-and-triggers">Events and Triggers</a>        <ul>
          <li><a href="#creating-a-trigger" id="markdown-toc-creating-a-trigger">Creating a Trigger</a></li>
          <li><a href="#cleaning-up-triggers" id="markdown-toc-cleaning-up-triggers">Cleaning up Triggers</a></li>
        </ul>
      </li>
      <li><a href="#more-on-editing" id="markdown-toc-more-on-editing">More on Editing</a>        <ul>
          <li><a href="#finding-text-with-regex" id="markdown-toc-finding-text-with-regex">Finding Text with Regex</a></li>
          <li><a href="#inserting-an-image-from-a-url" id="markdown-toc-inserting-an-image-from-a-url">Inserting an Image from a URL</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#putting-it-all-together" id="markdown-toc-putting-it-all-together">Putting it All Together</a>    <ul>
      <li><a href="#finding-image-urls" id="markdown-toc-finding-image-urls">Finding Image URLs</a></li>
      <li><a href="#transforming-urls-into-images" id="markdown-toc-transforming-urls-into-images">Transforming URLs Into Images</a></li>
      <li><a href="#resizing-the-appended-images" id="markdown-toc-resizing-the-appended-images">Resizing the Appended Images</a></li>
      <li><a href="#supporting-droplr-short-urls" id="markdown-toc-supporting-droplr-short-urls">Supporting Droplr Short URLs</a></li>
      <li><a href="#limiting-image-fetches" id="markdown-toc-limiting-image-fetches">Limiting Image Fetches</a></li>
    </ul>
  </li>
  <li><a href="#wrapping-up" id="markdown-toc-wrapping-up">Wrapping Up</a>    <ul>
      <li><a href="#the-whole-app-script" id="markdown-toc-the-whole-app-script">The Whole App Script</a></li>
    </ul>
  </li>
</ul>

<p>Until now I’ve mostly avoided the developer ecosystem around Google Apps like
Docs and Sheets. I didn’t really have a need for those APIs or any good ideas
about what to do with them. I have played with <a href="/2015/05/24/cities-skylines-gmaps-shortcuts/">Chrome Extensions</a>
a little bit in the past, but nothing very practical.</p>

<p>It turns out the <a href="https://developers.google.com/apps-script/">Google Apps Script</a>
platform is insanely powerful. You can build add-ons for Google Docs, Sheets,
and Forms including things like custom menus and buttons, custom code triggered
on an <a href="https://developers.google.com/apps-script/guides/triggers/installable">event basis</a>,
or even custom Sheet formula functions.</p>

<p>I hope to provide some insight into Google Apps Script based on what I learned while
building a small add-on. I’ll go over the steps I took to build the add-on, which is a simple
Google Apps Script that will find and replace image URLs in your Google Doc page with the image itself.</p>

<p>First, I’ll talk about the larger concepts needed to tackle it, then
I’ll go through the add-on itself, using those concepts along the way.</p>

<h2 id="google-apps-script">Google Apps Script</h2>

<blockquote>
  <p>  <em>“11 Google apps, 1 platform in the cloud”</em></p>
</blockquote>

<div class="googleapps-image center">
  <img src="/images/posts/googleapps.png" alt="Google Apps" />
</div>

<h3 id="what-is-it">What is it?</h3>

<blockquote>
  <p>Google Apps Script is a JavaScript cloud scripting language that
provides easy ways to automate tasks across Google products and
third party services and build web applications.</p>
</blockquote>

<p>Google Apps Script has a massive API but we’ll focus specifically on Docs.</p>

<p>An example of a Google Apps Script looks something like this:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Open a document by ID.</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">openById</span><span class="p">(</span><span class="s1">'DOCUMENT_ID_GOES_HERE'</span><span class="p">);</span>

<span class="c1">// Create and open a document.</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">'Document Name'</span><span class="p">);</span>

<span class="c1">// Use the current active document (more on that later).</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span></code></pre></figure>

<p>It’s JavaScript, but it exposes a ton of rich objects and interfaces that are
essentially the building blocks of a Google App, it’s pretty cool. The
<a href="https://developers.google.com/apps-script/reference/document/document-app"><code class="highlighter-rouge">DocumentApp</code></a>
refers to the Google Docs class that allows you to extend Google Docs behavior and features.</p>

<h4 id="elements-of-a-document">Elements of a Document</h4>

<p>Below is a Google Doc page, but I’ve marked it up with some of it’s common pieces.
Each piece is an element that you can either create or manipulate using
Google Apps Script, which remember is just plain old JavaScript.</p>

<div class="googleapps-image">
  <img src="/images/posts/googleapps-elements.png" alt="Google Apps Elements" />
</div>

<p>A full list of items including their hierarchy can be found on the
<a href="https://developers.google.com/apps-script/guides/docs#structure_of_a_document"><em>Extending Google Docs</em></a>
page. Each one of these elements has an extensive reference section that documents all
of the available methods, their return types, and a brief description. For
example,
<a href="https://developers.google.com/apps-script/reference/document/paragraph">here</a>
is the reference section for <code class="highlighter-rouge">Paragraph</code>.</p>

<p>I’ve really got to hand it to the Google Apps team for their documentation, it’s
really well structured, so much so that the URLs are quite navigable if you have
an idea what you’re looking for. I love me some guessable URLs.</p>

<h3 id="how-to-run-apps-script">How to Run Apps Script</h3>

<p>So you know a Google Doc is made up of several elements in a hierarchy. Those
elements have their own methods that can be used to manipulate (or for some, to
create) that element.</p>

<p>The next thing you probably want to know is <em>how</em> to use those methods. To do
so, you can go to <code class="highlighter-rouge">Tools &gt; Script Editor...</code> in the Google Docs toolbar.
From there you’ll be presented with a code editor that will allow you to type
in some code and run it. The code will be <a href="https://developers.google.com/apps-script/guides/bound">bound</a>
to the document you’re working in. This is important because it will allow us to
reference the document without an ID, using the third variation from earlier:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Use the current active document</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span></code></pre></figure>

<h4 id="adding-text-to-the-page">Adding Text to the Page</h4>

<p>With the script editor open, let’s do some simple editing of the document.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">myFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Get a reference to the current document</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>

  <span class="c1">// Get the active document's Body element</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="c1">// Add a paragraph to the end of the body</span>
  <span class="nx">body</span><span class="p">.</span><span class="nx">appendParagraph</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>Run the script by clicking the “Run” button or type ⌘ + R (you may have to give permission) then switch back to the
Google Doc and you should see the text has been added!</p>

<p><a href="/images/posts/googleapps-helloworld.gif"><img src="/images/posts/googleapps-helloworld.gif" alt="Google Apps Script: Logs" /></a></p>

<h4 id="using-the-logger">Using the Logger</h4>

<p>It’s really helpful to know how to print to and read from the log. To do so, you
can use the <code class="highlighter-rouge">Logger</code> object. Check out the example below:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">myFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Run the script using the “Run” button in the toolbar or type ⌘ + R. Then, to
view the logs go to <code class="highlighter-rouge">View &gt; Logs</code> or type ⌘ + Enter.</p>

<p><a href="/images/posts/googleapps-scripteditor.gif"><img src="/images/posts/googleapps-scripteditor.gif" alt="Google Apps Script: Logs" /></a></p>

<p>This will become really useful when we’re writing the script because we can
ensure method calls are returning the things we expect. Plus we can use the log
output to figure out which type of element we’re dealing with, which we can then
use to find the correct documentation.</p>

<p>Good old <a href="https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html">puts debugging</a>!</p>

<h3 id="events-and-triggers">Events and Triggers</h3>

<p>It’s all well and good to be able to run code manually with the run button, but
to make this actually useful, we need to know how to respond to actions that
occur, i.e. someone editing the document.  We need some way to activate our
code when we’ve pasted an image URL.</p>

<p>Enter Triggers.</p>

<blockquote>
  <p>Triggers let Apps Script run a function automatically when a certain event, like opening a document, occurs.</p>
</blockquote>

<p>Google Apps supports <a href="https://developers.google.com/apps-script/guides/triggers/">simple triggers</a> like <code class="highlighter-rouge">onChange</code> and <code class="highlighter-rouge">onOpen</code>,
so my first thought was <em>“oh perfect I can just use an onChange trigger!”</em> Unfortunately that trigger is only available for Sheets.
It runs when a column or row is added, removed or updated.</p>

<p>Since that’s not an option I kept digging and found that Google Apps also supports
<a href="https://developers.google.com/apps-script/guides/triggers/installable#time-driven_triggers">time driven triggers</a>,
which can execute a user-defined function at a given interval. The quickest
interval allowed is once per minute, but that’ll do.</p>

<h4 id="creating-a-trigger">Creating a Trigger</h4>

<p>To setup a time-based trigger it’s advised you do so in the <code class="highlighter-rouge">onOpen</code> function.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">myFunction</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>
  <span class="nx">body</span><span class="p">.</span><span class="nx">appendParagraph</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s2">"myFunction"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">everyMinutes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Save the code and run the <code class="highlighter-rouge">onOpen</code> function. You’ll probably have to select
the function from the dropdown menu to the right of the run button since
there are now two functions defined in your file.</p>

<p>After running the function, switch back to your document. Wait and watch for
a couple minutes while “Hello world” is added to the document over and over again.</p>

<h4 id="cleaning-up-triggers">Cleaning up Triggers</h4>

<p>If you run the <code class="highlighter-rouge">onOpen</code> function multiple times, you’ll find that the trigger
has been created again. You can see this by clicking on the “current project triggers”
button, directly left of the “Run” button.</p>

<p><a href="/images/posts/googleapps-triggers.png"><img src="/images/posts/googleapps-triggers.png" alt="google apps scripts: triggers" /></a></p>

<p>If you don’t delete triggers that were there before, your project will be filled
with duplicates which will cause your code to stop running and Google will let
kindly let you know.</p>

<p><a href="/images/posts/googleapps-triggererror.png"><img src="/images/posts/googleapps-triggererror.png" alt="google apps scripts: trigger error" /></a></p>

<p>You can run this function to clean up your triggers.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Deletes all triggers in the current project.</span>
<span class="c1">// https://developers.google.com/apps-script/reference/script/script-app#deletetriggertrigger</span>
<span class="kd">function</span> <span class="nx">deleteAllTriggers</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">triggers</span> <span class="o">=</span> <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">getProjectTriggers</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">triggers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">deleteTrigger</span><span class="p">(</span><span class="nx">triggers</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="more-on-editing">More on Editing</h3>

<p>Having a handle on the document and having the timer trigger in place, we essentially
have an event loop we can use to continually modify the document. To build the add-on
that automatically detects and replaces image URLs we’ll need a couple more pieces.</p>

<h4 id="finding-text-with-regex">Finding Text with Regex</h4>

<p>The <a href="https://developers.google.com/apps-script/reference/document/body"><code class="highlighter-rouge">Body</code></a>
class has a method called <a href="https://developers.google.com/apps-script/reference/document/body#findtextsearchpattern"><code class="highlighter-rouge">findText</code></a>
that we’ll need to find a URL and replace it with an image.</p>

<blockquote>
  <p>findText(searchPattern)
<br />
<br />
Searches the contents of the element for the specified text pattern using regular expressions.
The provided regular expression pattern is independently matched against each text block contained in the current element.</p>
</blockquote>

<p><cite>
<a href="https://developers.google.com/apps-script/reference/document/body#findText(String)">https://developers.google.com/apps-script/reference/document/body#findText(String)</a>
</cite></p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">logHelloWorldText</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="c1">// We'll just assume you still have the</span>
  <span class="c1">// "Hello world" in the document from earlier.</span>
  <span class="c1">// body.appendParagraph("Hello world!")</span>

  <span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"^Hello world!$"</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">selection</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Element: "</span> <span class="o">+</span> <span class="nx">element</span><span class="p">)</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Type: "</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getType</span><span class="p">())</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Text: "</span> <span class="o">+</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s2">"logHelloWorldText"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">everyMinutes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<div class="highlighter-rouge"><pre class="highlight"><code>[17-02-02 15:21:49:497 PST] Element: Text
[17-02-02 15:21:49:498 PST] Type: TEXT
[17-02-02 15:21:49:498 PST] Text: Hello world!
</code></pre>
</div>

<p>From the logs we can see we successfully found our <em>Hello world!</em> text in the
document. From there we can use methods on that Text element like <code class="highlighter-rouge">getText()</code> to
get or <code class="highlighter-rouge">setBold(true)</code> to make the text bold (go ahead, try it!).</p>

<h4 id="inserting-an-image-from-a-url">Inserting an Image from a URL</h4>

<p>Google docs has this functionality built in, so we’re basically replicating the
“Insert &gt; Image &gt; From URL…” functionality here. the <code class="highlighter-rouge">UrlFetchApp</code> provides a
wrapper around a method called <code class="highlighter-rouge">fetch</code> that lets us get content at the specified URL.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">insertUrlImage</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">"https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png"</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">fetch_img</span> <span class="o">=</span> <span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">imageblob</span> <span class="o">=</span> <span class="nx">fetch_img</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>
  <span class="nx">body</span><span class="p">.</span><span class="nx">appendImage</span><span class="p">(</span><span class="nx">imageblob</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Run that function and you should see the image appear shortly.</p>

<p>Going through line by line, we’re familiar with <code class="highlighter-rouge">doc</code> and <code class="highlighter-rouge">body</code> already. <code class="highlighter-rouge">url</code>
is of course the URL that points to the image we want to insert.</p>

<p>The <code class="highlighter-rouge">fetch_img</code> variable is using the <code class="highlighter-rouge">UrlFetchApp</code> class and the <code class="highlighter-rouge">fetch</code> method just mentioned.
This returns an <a href="https://developers.google.com/apps-script/reference/url-fetch/http-response"><code class="highlighter-rouge">HTTPResponse</code></a>
so <code class="highlighter-rouge">fetch_img</code> will contain an instance of that Class. The <a href="https://developers.google.com/apps-script/reference/url-fetch/http-response">HTTPResponse
reference</a>
docs list all of the methods available.</p>

<p>One method is the <code class="highlighter-rouge">getBlob</code> method that will give us the content from the URL as a
<a href="https://developers.google.com/apps-script/reference/base/blob"><code class="highlighter-rouge">Blob</code></a>.
Finally, the <code class="highlighter-rouge">appendImage</code> method on the body instance accepts a <code class="highlighter-rouge">BlobSource</code>
which conveniently our imageblob variable (the Blob) is one such source.</p>

<p>Here it is in action:</p>

<p><a href="/images/posts/googleapps-insertimg.gif"><img src="/images/posts/googleapps-insertimg.gif" alt="google apps scripts: insert image" /></a></p>

<hr />

<h2 id="putting-it-all-together">Putting it All Together</h2>

<p>To recap, we’ve got several pieces working independently. We know how to find
and change text in a document, and we can insert images from a URL. In addition,
we have a timed event trigger set up so our code can execute once per minute.</p>

<p>Now that we have an idea of each piece we’ll need, let’s make them all work together.</p>

<h3 id="finding-image-urls">Finding Image URLs</h3>

<p>First, let’s get the timed event trigger going and try to find a URL.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">insertImages</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>

  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Delete previous triggers</span>
  <span class="kd">var</span> <span class="nx">allTriggers</span> <span class="o">=</span> <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">getProjectTriggers</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">allTriggers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">deleteTrigger</span><span class="p">(</span><span class="nx">allTriggers</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// Run once immediately and then once per minute.</span>
  <span class="nx">insertImages</span><span class="p">();</span>
  <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s2">"insertImages"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">everyMinutes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p><a href="/images/posts/googleapps-logurl.gif"><img src="/images/posts/googleapps-logurl.gif" alt="google apps scripts: logurl" /></a></p>

<p>That’s great, but it only finds the first URL on the page. To get all URLs on
the page we can use plain old JavaScript. The <code class="highlighter-rouge">insertImages</code> method becomes:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">insertImages</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">selection</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastSelection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">,</span> <span class="nx">lastSelection</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">lastSelection</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>
      <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We use a <code class="highlighter-rouge">while</code> loop to find all occurrences of text that looks like a URL. We
track the <code class="highlighter-rouge">lastSelection</code> and pass it on each successive call so that Google
Docs doesn’t have to search from the top of the document every time.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>17-02-02 17:52:15:503 PST] https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png
<span class="o">[</span>17-02-02 17:52:15:505 PST] https://upload.wikimedia.org/wikipedia/commons/0/05/Twitter-logo-black.png
<span class="o">[</span>17-02-02 17:52:15:508 PST] https://upload.wikimedia.org/wikipedia/en/a/ae/Google_Docs,_Sheets,_and_Slides_Icon.png</code></pre></figure>

<p>Perfect. Getting closer. Now let’s just drop in the images.</p>

<h3 id="transforming-urls-into-images">Transforming URLs Into Images</h3>

<p>We can insert the images using the same URL fetching technique from earlier, but
this time we’ll be more careful by checking the content type of the blob before
we attempt to use it as an image. The <code class="highlighter-rouge">insertImages</code> method becomes:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">insertImages</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">selection</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastSelection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">,</span> <span class="nx">lastSelection</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">lastSelection</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>

      <span class="c1">// Retrieve the image from the web.</span>
      <span class="kd">var</span> <span class="nx">fetchimg</span> <span class="o">=</span> <span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">imageblob</span> <span class="o">=</span> <span class="nx">fetchimg</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">imageblob</span> <span class="o">&amp;&amp;</span> <span class="nx">imageblob</span><span class="p">.</span><span class="nx">getContentType</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"image"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">getParent</span><span class="p">().</span><span class="nx">appendInlineImage</span><span class="p">(</span><span class="nx">imageblob</span><span class="p">);</span>

        <span class="c1">// Remove the URL text element</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeFromParent</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>After the image is appended, we remove the Text element containing the URL from
it’s parent (the Body in this case). Finally, we’ve got the basic add-on
behavior we were looking for:</p>

<p><a href="/images/posts/googleapps-transformimgs.gif"><img src="/images/posts/googleapps-transformimgs.gif" alt="google apps scripts: transform images" /></a></p>

<h3 id="resizing-the-appended-images">Resizing the Appended Images</h3>

<p>A keen eye will notice the <code class="highlighter-rouge">resizeProportionally</code> function call after the image
is appended. If you provide a URL to a very large resolution image, the image
will hang off the document.</p>

<p>Instead, we can resize the image after it’s appended, so it starts off at a
better default. Below is a function we can use to resize an image so the
dimensions stay proportional.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Resize the image proportionally down to a max width/height</span>
<span class="kd">function</span> <span class="nx">resizeProportionally</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">maxWidth</span><span class="p">,</span> <span class="nx">maxHeight</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">maxWidth</span> <span class="o">=</span> <span class="nx">maxWidth</span> <span class="o">||</span> <span class="mi">600</span><span class="p">;</span>   <span class="c1">// default to 600 max width</span>
  <span class="kd">var</span> <span class="nx">maxHeight</span> <span class="o">=</span> <span class="nx">maxHeight</span> <span class="o">||</span> <span class="mi">600</span><span class="p">;</span> <span class="c1">// default to 600 max height</span>

  <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">widthRatio</span> <span class="o">=</span> <span class="nx">maxWidth</span> <span class="o">/</span> <span class="nx">width</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">heightRatio</span> <span class="o">=</span> <span class="nx">maxHeight</span> <span class="o">/</span> <span class="nx">height</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">widthRatio</span><span class="p">,</span> <span class="nx">heightRatio</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">newWidth</span>  <span class="o">=</span> <span class="nx">width</span>  <span class="o">*</span> <span class="nx">ratio</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">newHeight</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">newWidth</span> <span class="o">&lt;</span> <span class="nx">width</span> <span class="o">||</span> <span class="nx">newHeight</span> <span class="o">&lt;</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">setWidth</span><span class="p">(</span><span class="nx">newWidth</span><span class="p">);</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">setHeight</span><span class="p">(</span><span class="nx">newHeight</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>With that in place, <code class="highlighter-rouge">insertImages</code> becomes:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">insertImages</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">selection</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastSelection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">,</span> <span class="nx">lastSelection</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">lastSelection</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>

      <span class="c1">// Retrieve the image from the web.</span>
      <span class="kd">var</span> <span class="nx">fetchimg</span> <span class="o">=</span> <span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">imageblob</span> <span class="o">=</span> <span class="nx">fetchimg</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">imageblob</span> <span class="o">&amp;&amp;</span> <span class="nx">imageblob</span><span class="p">.</span><span class="nx">getContentType</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"image"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getParent</span><span class="p">().</span><span class="nx">appendInlineImage</span><span class="p">(</span><span class="nx">imageblob</span><span class="p">);</span>
        <span class="nx">resizeProportionally</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>

        <span class="c1">// Remove the URL text element</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeFromParent</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="supporting-droplr-short-urls">Supporting Droplr Short URLs</h3>

<p>I use <a href="http://droplr.com">Droplr</a> for screen captures when I need to
quickly share with someone. Once you’ve captured a screenshot, Droplr
automatically copies its short URL to your clipboard so you can paste it
in an email, a Google Doc, or wherever.</p>

<p>It makes for a nice workflow when you can simply snag a screenshot and paste its
short URL right into a Google Doc and have the image insert automatically.</p>

<p>To support this, a small change is required so the Blob data fetched is
the correct type. Droplr will provide the raw downloadable image if you
append a <code class="highlighter-rouge">+</code> to the end of the short URL.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="kd">function</span> <span class="nx">insertImages</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">selection</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastSelection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">,</span> <span class="nx">lastSelection</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">lastSelection</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>

      <span class="c1">// Droplr provides raw images if the URL is appended with +</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"d.pr/i/"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/</span><span class="se">\+</span><span class="sr">$/</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">"+"</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Retrieve the image from the web.</span>
      <span class="kd">var</span> <span class="nx">fetchimg</span> <span class="o">=</span> <span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">imageblob</span> <span class="o">=</span> <span class="nx">fetchimg</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">imageblob</span> <span class="o">&amp;&amp;</span> <span class="nx">imageblob</span><span class="p">.</span><span class="nx">getContentType</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"image"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getParent</span><span class="p">().</span><span class="nx">appendInlineImage</span><span class="p">(</span><span class="nx">imageblob</span><span class="p">);</span>
        <span class="nx">resizeProportionally</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>

        <span class="c1">// Remove the URL text element</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeFromParent</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Lines 15-17 show the relevant changes.</p>

<h3 id="limiting-image-fetches">Limiting Image Fetches</h3>

<p>If you have a really large Google Doc or happen to paste a large number of URLs
into the Document over the course of a minute, it may be useful to limit the
number of fetches that occur each time. During development, I also ran into the
page slowing and becoming unresponsive because of an accidental infinite while loop.</p>

<p>To prevent this from happening, a simple precondition on the while loop can be helpful:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">maxruns</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="nx">maxruns</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">,</span> <span class="nx">lastSelection</span><span class="p">)))</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span></code></pre></figure>

<hr />

<h2 id="wrapping-up">Wrapping Up</h2>

<p>If you’re still with me, that’s amazing. For such a small add-on, we went
through a lot to get there. Hopefully walking it through has given you a quick
dive into Google Apps Sheets enough so that you feel comfortable delving into
the documentation and trying out your own add-ons.</p>

<p>If you still want to keep going and improve what we have, you might try adding a
button to the UI that will replace the URLs when clicked. That way you don’t
have to wait for the 60 second interval to trigger again. &#x1f604;</p>

<h3 id="the-whole-app-script">The Whole App Script</h3>

<p>Here’s the entire thing, all put together:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">insertImages</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">DocumentApp</span><span class="p">.</span><span class="nx">getActiveDocument</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getBody</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">selection</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastSelection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">maxruns</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="nx">maxruns</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">selection</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">findText</span><span class="p">(</span><span class="s2">"https?://"</span><span class="p">,</span> <span class="nx">lastSelection</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">lastSelection</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">getElement</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>

      <span class="c1">// Droplr provides raw images if the URL is appended with +</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"d.pr/i/"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/</span><span class="se">\+</span><span class="sr">$/</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">"+"</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Retrieve the image from the web.</span>
      <span class="kd">var</span> <span class="nx">fetchimg</span> <span class="o">=</span> <span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">imageblob</span> <span class="o">=</span> <span class="nx">fetchimg</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">imageblob</span> <span class="o">&amp;&amp;</span> <span class="nx">imageblob</span><span class="p">.</span><span class="nx">getContentType</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"image"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Append the image and resize it</span>
        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getParent</span><span class="p">().</span><span class="nx">appendInlineImage</span><span class="p">(</span><span class="nx">imageblob</span><span class="p">);</span>
        <span class="nx">resizeProportionally</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>

        <span class="c1">// Remove the URL text element</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">removeFromParent</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Resize the image proportionally down to a max width/height</span>
<span class="kd">function</span> <span class="nx">resizeProportionally</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">maxWidth</span><span class="p">,</span> <span class="nx">maxHeight</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">maxWidth</span> <span class="o">=</span> <span class="nx">maxWidth</span> <span class="o">||</span> <span class="mi">600</span><span class="p">;</span>   <span class="c1">// default to 600 max width</span>
  <span class="kd">var</span> <span class="nx">maxHeight</span> <span class="o">=</span> <span class="nx">maxHeight</span> <span class="o">||</span> <span class="mi">600</span><span class="p">;</span> <span class="c1">// default to 600 max height</span>

  <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">widthRatio</span> <span class="o">=</span> <span class="nx">maxWidth</span> <span class="o">/</span> <span class="nx">width</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">heightRatio</span> <span class="o">=</span> <span class="nx">maxHeight</span> <span class="o">/</span> <span class="nx">height</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">widthRatio</span><span class="p">,</span> <span class="nx">heightRatio</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">newWidth</span>  <span class="o">=</span> <span class="nx">width</span>  <span class="o">*</span> <span class="nx">ratio</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">newHeight</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">newWidth</span> <span class="o">&lt;</span> <span class="nx">width</span> <span class="o">||</span> <span class="nx">newHeight</span> <span class="o">&lt;</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">setWidth</span><span class="p">(</span><span class="nx">newWidth</span><span class="p">);</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">setHeight</span><span class="p">(</span><span class="nx">newHeight</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onOpen</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Delete previous triggers</span>
  <span class="kd">var</span> <span class="nx">allTriggers</span> <span class="o">=</span> <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">getProjectTriggers</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">allTriggers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">deleteTrigger</span><span class="p">(</span><span class="nx">allTriggers</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// Run once immediately and then once per minute.</span>
  <span class="nx">insertImages</span><span class="p">();</span>
  <span class="nx">ScriptApp</span><span class="p">.</span><span class="nx">newTrigger</span><span class="p">(</span><span class="s2">"insertImages"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">timeBased</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">everyMinutes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Have you made something with Google Apps Script? Share it <a href="http://twitter.com/ronniemlr">on
Twitter</a>! I’d love to see it.</p>

<p>Cheers!</p>

      </div>
    </div>

    <hr />

    <h4 id="blog-about">About</h4>
    <p>
      Ronnie is a software developer located in Portland, OR.
      He works primarily in <a href="http://ruby-lang.org">Ruby</a> and
      <a href="http://rubyonrails.org">Ruby on Rails</a>, but he's also experienced
      in frontend development. In his spare time he enjoys hiking, snowboarding and
      flying planes.
    </p>
  </div>

  <footer>
    <ul id="profiles">
      <li><a href="http://github.com/mlr" class="symbol">circlegithubalt</span></a></li>
      <li><a href="http://linkedin.com/in/ronniemlr" class="symbol">circlelinkedin</span></a></li>
      <li><a href="http://twitter.com/ronniemlr" class="symbol">circletwitter</span></a></li>
    </ul>
  </footer>
</div>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-19173573-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>

