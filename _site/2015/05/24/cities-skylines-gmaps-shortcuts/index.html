
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta http-equiv="content-language" content="en-us" />
  <meta name="robots" content="index, follow" />
  <meta name="description" content="Ronnie Miller is a software developer living in Portland, Oregon. He utilizes Ruby, Rails and a variety of frontend tools to build workflow tools, web applications and whatever else happens to catch his interest." />
  <meta name="keywords" content="Ronnie Miller, software developer, web developer, software engineer, consultant, ruby, ruby on rails, jquery, emberjs, postgresql" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cities: Skylines &lt;3 Google Maps - Ronnie Miller - Software Developer</title>
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />

</head>

<body>
<div id="wrapper">
  <header>
    <div id="name"><a href="/">Ronnie Miller</a></div>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/work">Work</a></li>
      </ul>
    </nav>
  </header>

  <div id="container">

    <div id="content" class="blog-post cities-skylines-gmaps-shortcuts">
      <h1><a href="/2015/05/24/cities-skylines-gmaps-shortcuts/">Cities: Skylines &lt;3 Google Maps</a></h1>
      

      <div class="post-meta">
        <div class="post-date">
          May
          
          24th,
          2015
        </div>
      </div>

      <div class="post-content">
        <p>I’ve been playing some <a href="http://store.steampowered.com/app/255710/">Cities: Skylines</a>
this month. It brings back memories of the SimCity franchise,
before the <a href="http://mic.com/articles/29213/">always online fiaso</a>, except with
finer control over the city and a thriving <a href="https://steamcommunity.com/workshop/browse/?appid=255710&amp;requiredtags[]=Mod">library of
mods</a>.
Including <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=416064574">this mod</a>
that has a feature to export your creation to OpenStreetMap data. It’s pretty awesome.</p>

<p><img src="/images/posts/cities-skylines-map.png" alt="Cities: Skylines" /></p>

<p>Anyway, I noticed I quickly developed some muscle memory for the game’s keyboard
shortcuts for manipulating the map. I wanted to be able to use the same keyboard
shortcuts for Google maps to zoom the map, rotate, etc.  The only logical thing
to do is make it a Chrome extension!</p>

<p>I don’t remember if these are the default shortcuts or not,
but here’s what I wanted to do:</p>

<ul>
  <li><code>w</code><code>a</code><code>s</code><code>d</code> - pan - <em>This was not possible! <a href="#wasdfail">read why</a> below.</em></li>
  <li><code>z</code><code>x</code> - zoom in/out</li>
  <li><code>q</code><code>e</code> - rotate left/right</li>
  <li><code>t</code> - tilt</li>
</ul>

<h2 id="setting-up-the-chrome-extension">Setting up the Chrome extension</h2>

<p>This tutorial on <a href="http://code.tutsplus.com/tutorials/developing-google-chrome-extensions--net-33076">developing google chrome
extensions</a>
is pretty helpful to get a simple Google Chrome extension bootstrapped, running
and ready to start developing.</p>

<p>First I made a manifest file in a new directory.</p>

<figure>
<figcaption>manifest.json</figcaption>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-json" data-lang="json"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">"manifest_version"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"CS: Google Maps"</span><span class="p">,</span>
  <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"1.0"</span><span class="p">,</span>
  <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"A Cities: Skylines inspired keymapping for Google maps."</span><span class="p">,</span>
  <span class="nt">"content_scripts"</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">"matches"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"https://www.google.com/maps/*"</span><span class="p">],</span>
      <span class="nt">"js"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"content_scripts/jquery.js"</span><span class="p">,</span>
        <span class="s2">"content_scripts/mapkeys.js"</span>
      <span class="p">],</span>
      <span class="nt">"run_at"</span><span class="p">:</span> <span class="s2">"document_start"</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

</figure>

<p>Now navigating to <code>chrome://extensions</code> and clicking on the
“Load unpacked Extension…” button allows you to load this new extension.</p>

<p>It turns out, this is a pretty basic manifest as far as Chrome extensions go.
I just define two content scripts to load on any page matching a Google maps
URL. The first script is jQuery. The second is the main logic and behavior of
the extension, which I named mapkeys.js.</p>

<p>I didn’t need any background scripts, or any sort of setting pages. I didn’t even
define a browser action, so no tool bar button will appear when the extension is loaded.</p>

<h2 id="borrowing-the-map-buttons">Borrowing the map buttons</h2>

<p>Since Chrome extensions run in an isolated environment from the extension’s
content script and we can’t actually fire functions the page defines
itself, we have to piggy-back on the map buttons that are already there.</p>

<p>This turns out to be easier anyway because we don’t have to try to decipher the
minified JavaScript or play with the breakpoints to figure out what function we
need to call.</p>

<p>Basically, find the right element, trigger a click and let the existing event
handlers on the page handle the rest. These five lines end up being the bulk of
the extension’s behavior:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">'button[jsaction="compass.left"]'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span> <span class="c1">// rotate left</span></code></pre></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">'button[jsaction="compass.right"]'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span> <span class="c1">// rotate left</span></code></pre></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">'button.widget-tilt-button'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span> <span class="c1">// tilt</span></code></pre></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">'.widget-zoom-in'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span> <span class="c1">// zoom in</span></code></pre></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="s1">'.widget-zoom-out'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span> <span class="c1">// zoom out</span></code></pre></div>

<p>Google’s CSS class names make it pretty obvious what these do.  Try them in the
console of a Google maps page! You might have noticed, there’s nothing above for
panning the map. I’m getting to that, but you can <a href="#wasdfail">skip ahead</a>.</p>

<h2 id="listening-for-key-events">Listening for key events</h2>

<p>Handling <a href="http://javascript.info/tutorial/keyboard-events">keyboard events with
JavaScript</a> is pretty straight
forward, but theres some other considerations that have to be made for this
extension to feel right. In order to not break the UX of Google’s existing
features, I had to do four things:</p>

<ol>
  <li>
    <p><strong>Ignore keys when searching</strong> - If the user is typing a search query, ignore
any keyboard events and just return. To actually utilize the keyboard shortcuts
the user will need to click somewhere on the map or otherwise take focus off
of the search box.</p>
  </li>
  <li>
    <p><strong>Ignore keys when panning</strong> - If the user is using the arrow keys to move
and pan the map, again just ignore any keyboard events and return. The map
becomes jumpy if you’re simultaneously panning and trying to rotate
the map with a mapped key.</p>
  </li>
  <li>
    <p><strong>Switch to Earth view</strong> - In order to rotate or tilt the map it must
be in Earth view. So, switch to Earth view before attempting to zoom or tilt.
Don’t automatically switch to Earth view when zooming because that’s
available on the default map view.</p>
  </li>
  <li>
    <p><strong>Bind keydown handler to the</strong> <code>window</code> <strong>object</strong> -
When the keydown event is captured, we must stop its propagation
then and there. This is why you’ll see I bound my keydown listener
directly on the window object. Any lower and I wouldn’t be able to prevent
the page from getting it. The result is the map is turning and
zooming while the search box is filled with silly text like “qeettqzzxqxxq”
because Google has their own keydown event that focuses the search field when
you begin to type. Stopping the propagation prevents that. The user can still
type in the search field, but they have to focus it themselves.</p>
  </li>
</ol>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>The full mapkeys.js can be seen below. For the full project,
check out the <a href="http://github.com/mlr/gmaps-keyboard-shortcuts">repository</a>.</p>

<figure>
<figcaption>mapkeys.js</figcaption>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-javascript" data-lang="javascript"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'keydown'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#searchboxinput'</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">':focus'</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">currentlyPanningMap</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nx">pressed</span> <span class="o">=</span> <span class="nx">letter</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">pressed</span> <span class="o">!=</span> <span class="s1">'Z'</span> <span class="o">&amp;&amp;</span> <span class="nx">pressed</span> <span class="o">!=</span> <span class="s1">'X'</span><span class="p">)</span> <span class="nx">switchToEarthMap</span><span class="p">();</span>

  <span class="nx">event</span><span class="p">.</span><span class="nx">stopImmediatePropagation</span><span class="p">();</span>
  <span class="nx">applyKeyMapping</span><span class="p">(</span><span class="nx">pressed</span><span class="p">);</span>
<span class="p">},</span> <span class="kc">true</span><span class="p">);</span>

<span class="nx">currentlyPanningMap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">chr</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">chr</span> <span class="o">&gt;=</span> <span class="mi">37</span> <span class="o">&amp;&amp;</span> <span class="nx">chr</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">switchToEarthMap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="s1">'button[jsaction="compass.left"]'</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'.widget-minimap-shim-button'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">letter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">applyKeyMapping</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">letter</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">letter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'Q'</span><span class="o">:</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'button[jsaction="compass.left"]'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'E'</span><span class="o">:</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'button[jsaction="compass.right"]'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'Z'</span><span class="o">:</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'.widget-zoom-in'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'X'</span><span class="o">:</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'.widget-zoom-out'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'T'</span><span class="o">:</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'button.widget-tilt-button'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

</figure>

<p>The first 10 lines execute the logic of this extension when a key is pressed,
including each of the four UX considerations I outlined above. The <code>applyKeyMapping</code>
function takes the letter pressed and fires a click on the appropriate Google map button.
I’m checking the letter pressed rather than the keycode simply for easier modification later.</p>

<p>That’s it! Now I can zoom, rotate and tilt the map with custom keyboard shortcuts!</p>

<p><a name="wasdfail"></a></p>

<h2 id="why-panning-was-a-lost-cause">Why panning was a lost cause</h2>

<p>I hinted at the <a href="https://developer.chrome.com/extensions/content_scripts#execution-environment">isolated
environment</a>
Chrome extensions are executed in.  What it boils down to is that you can only
access the DOM of the page the content script is executed on. Since the page has
buttons available for all the other actions (rotate, zoom, tilt), those were
pretty trivial to implement. There are no buttons for panning unfortunately.</p>

<p>Google already has panning available using the keyboard’s arrow keys. Maybe you
could just emulating the arrow buttons being pressed!</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// added to switch statement</span>
<span class="k">case</span> <span class="s1">'S'</span><span class="o">:</span>
  <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s1">'keydown'</span><span class="p">);</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="c1">// down arrow</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span></code></pre></div>

<p>Unfortunately, this solution doesn’t work.  Neither do the other <a href="http://stackoverflow.com/questions/10455626/">various
solutions for keypress emulation</a>.
I suspect this may be due to the isolated environments as well, but honestly I’m
not entirely certain.</p>

<p>Maybe I could reimplement the behavior of panning! Let’s see… need functions
to load map tiles for your current location, stitch tiles together, redraw the map
canvas… Yeah. I think I’ll just use the arrow keys for panning.</p>

      </div>
    </div>

    <hr />

    <h4 id="blog-about">About</h4>
    <p>
      Ronnie is a software developer located in Portland, OR.
      He works primarily in <a href="http://ruby-lang.org">Ruby</a> and
      <a href="http://rubyonrails.org">Ruby on Rails</a>, but he's also experienced
      in frontend development. In his spare time he enjoys hiking, snowboarding and
      flying planes.
    </p>
  </div>

  <footer>
    <ul id="profiles">
      <li><a href="http://github.com/mlr" class="symbol">circlegithubalt</span></a></li>
      <li><a href="http://linkedin.com/in/ronniemlr" class="symbol">circlelinkedin</span></a></li>
      <li><a href="http://twitter.com/ronniemlr" class="symbol">circletwitter</span></a></li>
    </ul>
  </footer>
</div>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-19173573-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>

